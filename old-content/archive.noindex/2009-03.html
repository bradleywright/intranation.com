<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
    	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    	<meta name="generator" content="Tumblr Backup 0.3>" />
    	<meta name="backup-date" content="Sat, 07 May 11 14:51:15 -0400" />
    	<link rel="stylesheet" href="../style.css"/>
    	<link rel="icon" href="../avatar.png"/>
    </head>
    <body class="archive_body">        
        <div class="post_meta">
            <span class="timestamp">March 22, 2009, 7:53 pm</span>
            <a class="permalink" href="../posts/766289691.html">#</a>
        </div>
        
        <h1>Development virtual machines on OS X using VMWare and Ubuntu</h1><div><p><strong>Update 21st Febuary, 2010:</strong> If you get this error when installing VMWare Tools: <code>mount: unknown filesystem type 'iso9660'</code>, it’s because you’re using Ubuntu 9.10 in JeOS mode. The solution is to <a href="http://ubuntuforums.org/showthread.php?t=1314412">upgrade your kernel to the generic, rather than virtual, kernel</a>.</p>  <p><strong>Update 26th November, 2009:</strong> <a href="http://mikewest.org">Mike West</a> has pointed out that the Linux headers required differ from version to version, so I’ve updated the instructions to reflect the header install required. Also, the JeOS version of Ubuntu 8.04&#160;<abbr title="Long term support">LTS</abbr> is <a href="http://cdimage.ubuntu.com/jeos/releases/8.04/release/">available at a different <abbr title="Uniform resource locator">URL</abbr> than the normal distribution</a>.</p>  <p><strong>Update 29th June, 2009:</strong> <a href="http://blogs.vmware.com/teamfusion/2009/06/vmware-fusion-205-update-now-available.html">VMWare Fusion 2.0.5 has been released</a>, which contains an updated VMWare Tools package for Ubuntu 9.04. This removes the requirement to edit the source files as <a href="http://swearingscience.com/2009/04/04/ubuntu-904-beta-in-vmware-fusion/">outlined here</a>.</p>  <p><strong>Update 21st June, 2009:</strong> it’s been pointed out that Ubuntu 8.10, which this article was originally written for, has been replaced by the <a href="https://wiki.ubuntu.com/HardyHeron">8.04&#160;<abbr title="Long term support">LTS</abbr> release</a>. If you want a stable version of Ubuntu, rather than the bleeding edge, you’re best off using this release.</p>  <p>I’ve been using Linux as my primary development environment for a number of months now, despite being an abject Mac fanboy. Why?</p> <ul><li>I often want to try new software (<a href="http://www.python.org/download/releases/2.6.1/">Python 2.6</a>, <a href="http://nginx.net/">Nginx</a>, <a href="http://www.modwsgi.org/">mod_wsgi</a>, or <a href="http://couchdb.apache.org/">CouchDB</a>, for example), and neither <a href="http://www.macports.org/">MacPorts</a> nor <a href="http://www.finkproject.org/">Fink</a> are really appropriate to my needs, as it’s too easy to break your system using it (and to give you an idea of how invasive MacPorts is, just take a look at the <a href="http://guide.macports.org/#installing.macports.uninstalling">uninstallation instructions</a>!);</li>     <li><abbr title="Macintosh Operating System 10">OS X</abbr>, being both a consumer desktop OS and a <a href="http://en.wikipedia.org/wiki/OSX#History">BSD–derived UNIX</a>, is nothing like any of the commodity hosting available (usually Debian–derived systems like <a href="http://www.ubuntu.com/">Ubuntu</a> for me), so releasing stuff requires more testing (both locally and then in a “production–like” environment) before I can be sure it’ll work; but mostly</li>     <li>The penalty for screwing up is too high. I live in fear of trashing the default Apache or Python on my Mac and not being able to recover from it.</li> </ul><p>I will continue to use my Mac as my main machine, because I love <a href="http://www.omnigroup.com/applications/omnifocus/">OmniFocus</a>, and <a href="http://www.apple.com/safari/">Safari</a>, and <a href="http://vmware.com/products/fusion/">VMWare Fusion</a>, and all the other applications on my Mac. I love the toolset available to me, and value the user experience.</p> <p>So what’s the solution? Virtualisation, of course. Thanks to VMWare’s shared folders feature, we can mirror our local folders into the VM, making it super–easy to run our code in Linux (and it also means we don’t have to use Samba).</p> <p>Following are some (hopefully) bulletproof instructions for setting up <a href="http://www.ubuntu.com/products/whatisubuntu/serveredition/jeos" title="Juice">JeOS</a> (a virtual–machine friendly version of Ubuntu Server, as pointed out to me by <a href="http://dannyamey.com/" rel="friend met colleague">Danny Amey</a>) in VMWare in such a way as to make it an ideal development environment.</p> <ol><li>Firstly, get the latest Ubuntu Server from the <a href="http://www.ubuntu.com/getubuntu/download">download page</a> (via BitTorrent or any other convenient method). Note that JeOS is listed as a feature of the distribution: <q>Ubuntu Server Edition JeOS (pronounced &#8220;Juice&#8221;) is an efficient variant of our server operating system, configured specifically for virtual appliances</q>;</li>     <li>Then start VMWare Fusion up, and create a new Virtual Machine. I recommend 256MB RAM and HDD of about 10GiB. Name it whatever you like (let&#8217;s say “JeOS” for this example);</li>     <li>When asked for a CD–ROM, point VMWare at the location of the ISO you just downloaded;</li>     <li>You’ll want to turn printers off, as JeOS doesn&#8217;t seem to deal very well with printers—probably because it’s quite minimal and doesn&#8217;t ship with printer capability;</li>     <li>Follow the other steps as normal.</li> </ol><p>You now have a fresh virtual machine. Polish the settings (change HDD size, for example), and start it up.</p> <ol><li>Initially you’ll see a language screen. Choose the appropriate language (“English” for me, obviously);</li>     <li>After choosing the language, you’re presented with an install menu. At this point, we need to differ from the usual Ubuntu install process and change our install mode. Hit “F4” (or “fn + F4”) to open the modes menu, and select “Install a minimal virtual machine”;</li>     <li>Follow the rest of the install process as usual (name your user, name your server etc.).</li> </ol><p>It’s worth nothing that at this point I don’t normally install any of the pre–configured server options—I just leave it as bare bones as possible.</p>  <p>Now the machine will start up, so we can install VMWare tools. This gives us the benefit of Shared Folders, which let us treat the machine as a local folder, so we can use <a href="http://macromates.com/">TextMate</a> or other local tools to edit files within the system. This is the real key to making the development VM usable.</p>  <p>After the machine starts up in a VMWare window, log in and type <kbd>ifconfig</kbd>. Take note of the IP address in the <samp>eth0</samp> section alongside <samp>inet addr:</samp>. This is the IP address of your virtual machine (if you’re using <acronym title="Network Address Translation">NAT</acronym>—if you’re using bridged it’ll be a non-local IP).</p>  <p>Since the terminal provided by basic Linux is a bit sparse on features, install SSH with <kbd>sudo apt-get install ssh</kbd>. When this completes, log out and open Terminal.app.</p>  <p>SSH into the system with <var>ssh [username]@[ip address]</var>. You’ll need to accept the dialogue about the MAC address fingerprint.</p>  <p>Now we need to update the system a bit. Run:</p>  <ol><li><kbd>sudo apt-get update</kbd> (this updates the package sources);</li>     <li><kbd>sudo apt-get upgrade</kbd> (this updates the installed packages); and</li>     <li><kbd>sudo apt-get dist-upgrade</kbd> (only if there’s a newer version of Ubuntu floating around—probably not at time of writing)—if you do this, see <a href="#addendum">below</a>.</li> </ol><p id="addendum"><strong>Note:</strong> if you ran <kbd>dist-upgrade</kbd> above, you should restart your virtual machine now with: <kbd>sudo shutdown -r now</kbd>. Otherwise you may get clashes with kernel versions in the next step (thanks <a href="http://www.isolani.co.uk/" rel="friend met colleague">Mike Davies</a>).</p>  <p>Now we can get on with installing VMWare tools.</p>  <ol><li><kbd>sudo apt-get install linux-headers-$(uname -r) build-essential</kbd> (installs some software required to build the components of VMWare tools);</li>     <li>In Fusion, install VMWare tools with the “Virtual Machine &gt; Install VMWare Tools” menu dialogue. This causes a fake CD–ROM to be inserted into the machine;</li>     <li>Back in SSH, mount the CD with <kbd>sudo mount /cdrom</kbd>;</li>     <li>Create a new directory to compile source code: <kbd>mkdir -p ~/src</kbd>;</li>     <li>Enter the CD: <kbd>cd /cdrom/</kbd></li>     <li>Copy the source code of VMWare across: <kbd>cp VMwareTools-[HIT TAB TO COMPLETE] ~/src</kbd>;</li>     <li><kbd>cd ~/src</kbd>;</li>     <li><kbd>tar zxfv VMwareTools-[HIT TAB TO COMPLETE]</kbd>;</li>     <li><kbd>cd vmware-tools-distrib</kbd>;</li>     <li>Now we can install VMWare Tools: <kbd>sudo ./vmware-install.pl [--default]</kbd>.</li> </ol><p>At this point you can basically accept all the default dialogue options until it completes. <strong>Edit:</strong> as <a href="http://mikewest.org/" rel="friend met colleague">Mike West</a> has rightly pointed out, passing the <code>--default</code> flag to the install command automatically accepts all defaults for you.</p> <p>Now you’ve installed VMWare Tools, so it’s time to mount the remote folder:</p> <ol><li>In the VMWare Library, edit the Settings of your currently running virtual machine;</li>     <li>Select the “Sharing” settings option;</li>     <li>Add a new folder (in mine my code is stored in <samp>~/Projects</samp>) and share it with Read/Write permissions;</li>     <li>Close the menu dialogue to save your choice.</li> </ol><p>This folder is now available to the VM at <samp>/mnt/hgfs/[NAME OF FOLDER]</samp>, except there’s one issue: because of the way the mount works, the VM can’t write back to the shared folder (which is a problem if you’re compiling anything, for example). Here’s how you enable read–write for real:</p>  <ol><li>Work out your user and main group ID by typing: <kbd>id</kbd> (this will usually be <var>1000</var> and <var>1000</var>);</li>     <li>Edit your sharing settings with: <kbd>sudo vi /etc/fstab</kbd>;</li>     <li>Edit the line starting with: <samp>.host:/    /mnt/hgf</samp> to look like: <samp>.host:/    /mnt/hgfs    vmhgfs    defaults,ttl=5,uid=1000,gid=1000  0</samp>, where <samp>uid=1000</samp> and <samp>gid=1000</samp> are the actual user and group IDs we discovered back in the first step.</li> </ol><p>Now your VM can write back to the shared folder, and all is well.</p>  <h2>Bonus topics</h2>  <h3>Link your shared folder into your home directory</h3>  <p>If you want the shared folder reflected in your user home directory, just use a symlink:</p>  <pre><kbd>ln -s /mnt/hgfs/Projects ~/projects</kbd></pre>  <h3>Run the VM in headless mode</h3>  <p>So you don’t need to start VMWare each time, you can run the virtual machines as a separate process outside of VMWare Fusion. This is called “<a href="http://communities.vmware.com/docs/DOC-1201">headless mode</a>”. From a local terminal on your Mac, type:</p>  <pre><kbd>defaults write com.vmware.fusion fluxCapacitor -bool YES</kbd></pre>  <p>and restart VMWare. When you start your machine, choose “View &gt; Enter Headless”. The screen will disappear for that machine, and it’ll keep running. Now you can close VMWare with a running VM and not have the machine stop. <a href="http://github.com/bradleywright/homedir/blob/70072383df8149edc6a754e8d11ea7fd8d0ce8f9/bin/vm">Use this script I wrote to start machines via the command line</a> (so you can even bypass VMWare Fusion altogether).</p>  <h2>Final notes</h2>  <p>At this point it’s wise to use the snapshot feature of VMWare Fusion to save the state of your machine, in case you completely trash it and want to restore from scratch. This is one of the biggest wins of virtualisation in my opinion—making it easy and non–dangerous to experiment.</p>  <p>Also, thanks to Danny for helping me out a bit and <a href="http://nefariousdesigns.co.uk" rel="friend met colleague">Tim Huegdon</a> for being my guinea pig.</p>  <h2>Update: A note on Symfony</h2>  <p>A <a href="http://johngrimsey.co.uk/" rel="colleague">few</a> <a href="http://rajatpandit.com/" rel="friend met colleague">people</a> have written and asked me about how to get <a href="http://www.symfony-project.org/">Symfony</a> running under this set up. Symfony has slightly peculiar requirements in that it needs to have a PHP/Apache writable directory in which it can dump the compiled YML files it uses for configuration. The solution to this is to patch <samp>/etc/apache2/apache2.conf</samp> as follows:</p>  <pre><code>User [your username here] Group [your groupname here (usually the same as the username)]</code></pre>  <p>and then reboot Apache.</p>  <p>This configuration means that Symfony runs with the same permissions as your primary user, which gives it full control over your project directories, and also inherits the permissions granted by HGFS. Needless to say: <strong>never do this on a public web server</strong>.</p></div>
</body></html>